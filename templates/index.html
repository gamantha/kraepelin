<html>
    <head>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
        <!-- bootstrap css and js -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <!-- bootstrap css and js -->
        <!-- jquery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <title>{{title}}</title>
    </head>
    <body>
        <h1 class="text-center text-warning">Kraepelin Test</h1>
        <div class="text-center">
            <button id="btn_start" type="button" class="btn btn-primary text-center">Mulai</button>
        </div>
        <h5 class="text-center text-info" id="countdowntimer">Selamat Datang</h5>
        <table class="table table-striped">
            {% set total_tab = (data|length)*(data[0]|length) %}
            {% for i in data %}
                <tr class="w-">
                    {% for j in i %}
                        <td class="text-center">
                            <span class="question-point">
                                {{ j }}
                            </span>
                        </td>
                    {% endfor %}
                </tr>
                {% if loop.index < i|length %}
                    {% set outer_loop_in = loop.index %}
                    <tr>
                        {% for k in range(i|length) %}
                            {% set inner_loop_in = loop.index %}
                            <td class="text-right">
                                <input tabindex="{{ total_tab - (inner_loop_in + (outer_loop_in * i|length)) }}" min="0" max="9" class="text-right input-answer" type="number"/>
                            </td>
                        {% endfor %}
                    </tr>
                {% endif %}

            {% endfor %}

        </table>
        <div class="text-center">
            <button id="btn_finish" disabled class="btn btn-primary">Selesai</button>
        </div>
    </body>
    <script>
        var questions = {{ data | tojson }};
        var col = questions[0].length;
        var curr_col = -1;
        var toggleStart = false;
        var x;
        $("#btn_start").bind("click", startTimer);
        $("#btn_finish").bind("click", postResult);
        toggleInput(true)

        function toggleInput(disabled, emptyFlag = true) {
            var inputs = $(".input-answer")
            for (var i = 0; i < inputs.length; i++) { 
                inputs[i].disabled = disabled;
                if (emptyFlag) {
                    inputs[i].value = '';
                }
            }
        }
        
        function toggleUserInput(col_index) {
            toggleInput(true, false);
            var inputs = $(".input-answer")
            for (var i = col_index; i < inputs.length; i+=col) { 
                inputs[i].disabled = false;
                inputs[i].value = '';
                inputs[i].focus();
            }
        }

        function fetchAnswers() {
            result = []
            var inputs = $(".input-answer")
            for (var i = 0; i < inputs.length; i++) { 
                result.push(parseInt(inputs[i].value));
            }
            return result
        }

        function startTimer() {
            if(toggleStart === true) {
                toggleStart = false;
                clearInterval(x);
                $("#countdowntimer").html("Selamat Datang");
                $("#btn_start").html("Mulai");
                $("#btn_finish").prop('disabled', true);
                toggleInput(true);
            } else {
                toggleStart = true;
                curr_col = 0;
                toggleUserInput(curr_col);
                Date.prototype.addHours= function(h){
                    this.setHours(this.getHours()+h);
                    return this;
                }
                var countDownDate = new Date().addHours(1).getTime();
                // Change button label
                $("#btn_start").html("Berhenti")
                $("#btn_finish").prop('disabled', false);
                // Update the count down every 1 second
                x = setInterval(function() {
                    // Get todays date and time
                    var now = new Date().getTime();

                    // Find the distance between now and the count down date
                    var distance = countDownDate - now;

                    // Time calculations for days, hours, minutes and seconds
                    // var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    // var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    var seconds = Math.floor((distance % (1000 * 20)) / 1000);

                    // Display the result in the element with id="demo"
                    $("#countdowntimer").html(seconds + " detik ");

                    // every 20 second
                    if (seconds % 20 == 0) {
                        console.log(distance, distance%20)
                        curr_col++;
                        if (curr_col >= col) {
                            clearInterval(x);
                            toggleInput(true);
                            postResult();
                            location.reload();
                        }
                        toggleUserInput(curr_col);
                    }
                }, 1000);
            }

        }

        function postResult() {
            answers = fetchAnswers();
            $.ajax({
                url: '/assess',
                contentType: 'application/json',
                accepts: 'application/json',
                method: 'POST',
                data: JSON.stringify({payload: {
                    questions,
                    answers,
                    user_id: '123',
                }})
            }).done(function (data) {
                confirm('jawaban anda telah terkumpul.');
                location.reload();
            }).fail(function (err) {
                location.reload();
            })
        }
    </script>

</html>